name: PR Documentation

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  document-pr:
    name: Generate PR Documentation
    runs-on: ubuntu-latest
    # Only run on merged PRs, skip bot PRs, and prevent infinite loops
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.user.type != 'Bot' &&
      !startsWith(github.event.pull_request.title, 'docs: Add documentation for PR') &&
      vars.VERTEX_AI_PROJECT_ID != ''

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.VERTEX_AI_CREDENTIALS }}

      - name: Generate PR Documentation
        uses: textcortex/claude-code-pr-autodoc-action@v1
        with:
          model: "claude-opus-4-5@20251101"
          use_vertex: "true"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          min_lines_changed: 25
          min_files_changed: 1
          documentation_directory: docs/
          timeout_minutes: 15
          commit_tags: "[skip ci]"
          pr_title_tags: "[skip ci]"
          custom_instructions: |
            This is Qbit, an AI-powered terminal emulator built with Tauri 2 (Rust backend, React 19 frontend).

            Key areas of the codebase:
            - frontend/: React frontend with shadcn/ui, Zustand state management
            - backend/src/: Rust backend with AI agent system, PTY management, settings, indexer
            - backend/crates/: Local Rust crates (rig-anthropic-vertex)

            When documenting PRs:
            - Create or update documentation for any new or changed features
            - Note any changes to the AI agent system (backend/src/ai/)
            - Highlight terminal/PTY changes (backend/src/pty/)
            - Call out frontend component changes
            - Mention any changes to the event system (AiEvent, terminal events)
            - Note configuration/settings changes
